@using System.Globalization
@using System.Linq
@using Bookstore.Helpers
@model PaginatedList<Order>
@{
    ViewData["Title"] = "Quản lý đơn hàng";
    var currencyCulture = CultureInfo.GetCultureInfo("vi-VN");
    string DisplayValue(string? value) => string.IsNullOrWhiteSpace(value) ? "—" : value;
    string FormatCurrency(decimal amount) => string.Format(currencyCulture, "{0:C0}", amount);
    string TranslatePaymentStatus(string? status)
    {
        if (string.IsNullOrWhiteSpace(status))
        {
            return "Không rõ";
        }

        return status.Trim().ToLowerInvariant() switch
        {
            "paid" => "Đã thanh toán",
            "pending" => "Chờ thanh toán",
            "processing" => "Đang xử lý",
            "failed" => "Thanh toán thất bại",
            "cod" => "Thanh toán khi nhận hàng",
            "refunded" => "Đã hoàn tiền",
            _ => status
        };
    }

    string TranslateOrderStatus(string? status)
    {
        if (string.IsNullOrWhiteSpace(status))
        {
            return "Không rõ";
        }

        return status.Trim().ToLowerInvariant() switch
        {
            "pending" => "Chờ xử lý",
            "processing" => "Đang xử lý",
            "shipped" => "Đã gửi hàng",
            "delivered" => "Đã giao hàng",
            "completed" => "Hoàn tất",
            "cancelled" => "Đã hủy",
            _ => status
        };
    }

    string PaymentStatusClass(string? status)
    {
        if (string.IsNullOrWhiteSpace(status))
        {
            return "bg-secondary";
        }

        return status.Trim().ToLowerInvariant() switch
        {
            "paid" => "bg-success",
            "pending" => "bg-warning text-dark",
            "processing" => "bg-warning text-dark",
            "failed" => "bg-danger",
            "cod" => "bg-primary",
            "refunded" => "bg-info text-dark",
            _ => "bg-secondary"
        };
    }

    string OrderStatusClass(string? status)
    {
        if (string.IsNullOrWhiteSpace(status))
        {
            return "bg-secondary";
        }

        return status.Trim().ToLowerInvariant() switch
        {
            "pending" => "bg-warning text-dark",
            "processing" => "bg-info",
            "shipped" => "bg-primary",
            "delivered" => "bg-success",
            "completed" => "bg-success",
            "cancelled" => "bg-danger",
            _ => "bg-secondary"
        };
    }
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<!-- Orders Card -->
<div class="admin-card">
    <div class="admin-card-header d-flex justify-content-between align-items-center">
        <h5 class="admin-card-title mb-0">
            <i class="bi bi-cart-check me-2"></i>Danh sách đơn hàng
        </h5>
        <span class="badge bg-primary">Tổng @Model.TotalPages trang</span>
    </div>
    <div class="admin-card-body p-0">
        @if (Model.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover admin-table mb-0">
                    <thead>
                        <tr>
                            <th>Mã đơn hàng</th>
                            <th>Khách hàng</th>
                            <th>Ngày đặt</th>
                            <th class="text-end">Tổng tiền</th>
                            <th class="text-center">Thanh toán</th>
                            <th class="text-center">Trạng thái</th>
                            <th class="text-center" style="width: 120px;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in Model)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="order-icon me-3">
                                            <i class="bi bi-receipt"></i>
                                        </div>
                                        <strong class="text-primary">@(order.OrderNumber ?? $"#{order.OrderId:0000}")</strong>
                                    </div>
                                </td>
                                <td>
                                    <div class="fw-semibold text-dark">@DisplayValue(!string.IsNullOrWhiteSpace(order.User?.FullName) ? order.User!.FullName : order.User?.Email)</div>
                                    <small class="text-muted">@DisplayValue(order.User?.Email)</small>
                                </td>
                                <td>
                                    <div>@order.OrderDate.ToString("dd/MM/yyyy")</div>
                                    <small class="text-muted">@order.OrderDate.ToString("HH:mm")</small>
                                </td>
                                <td class="text-end fw-bold text-success">@FormatCurrency(order.Total)</td>
                                <td class="text-center">
                                    <span class="badge rounded-pill @PaymentStatusClass(order.PaymentStatus)">
                                        @TranslatePaymentStatus(order.PaymentStatus)
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge rounded-pill @OrderStatusClass(order.OrderStatus)">
                                        @TranslateOrderStatus(order.OrderStatus)
                                    </span>
                                </td>
                                <td class="text-center">
                                    <a asp-area="Admin" asp-controller="Orders" asp-action="Details" asp-route-id="@order.OrderId" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye me-1"></i>Chi tiết
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
                </div>
                <h4 class="text-muted">Chưa có đơn hàng nào</h4>
                <p class="text-muted mb-0">Các đơn hàng mới sẽ xuất hiện ở đây.</p>
            </div>
        }
    </div>
    
    @if (Model.TotalPages > 1)
    {
        <div class="admin-card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="text-muted">
                <i class="bi bi-info-circle me-1"></i>Trang @Model.PageIndex / @Model.TotalPages
            </div>
            <nav>
                <ul class="pagination mb-0">
                    <li class="page-item @(Model.HasPreviousPage ? string.Empty : "disabled")">
                        <a class="page-link" asp-area="Admin" asp-controller="Orders" asp-action="Index" asp-route-page="@(Model.PageIndex - 1)">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    @for (var pageNumber = 1; pageNumber <= Model.TotalPages; pageNumber++)
                    {
                        <li class="page-item @(pageNumber == Model.PageIndex ? "active" : string.Empty)">
                            <a class="page-link" asp-area="Admin" asp-controller="Orders" asp-action="Index" asp-route-page="@pageNumber">@pageNumber</a>
                        </li>
                    }
                    <li class="page-item @(Model.HasNextPage ? string.Empty : "disabled")">
                        <a class="page-link" asp-area="Admin" asp-controller="Orders" asp-action="Index" asp-route-page="@(Model.PageIndex + 1)">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    }
</div>

@section Styles {
<style>
    .order-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--admin-primary) 0%, #764ba2 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.1rem;
    }
    
    .admin-card-footer {
        padding: 1rem 1.5rem;
        background: #f8f9fc;
        border-top: 1px solid #e3e6f0;
    }
</style>
}
