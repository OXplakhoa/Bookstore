@model Bookstore.ViewModels.Admin.FlashSaleAnalyticsViewModel

@{
    ViewData["Title"] = "Flash Sale Analytics";
    var statusColor = Model.Status switch
    {
        "Active" => "success",
        "Upcoming" => "info",
        "Expired" => "secondary",
        _ => "warning"
    };
}

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-graph-up"></i> Flash Sale Analytics</h2>
            <p class="text-muted mb-0">@Model.Name</p>
        </div>
        <div>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Quay lại danh sách
            </a>
            <a asp-action="Details" asp-route-id="@Model.FlashSaleId" class="btn btn-outline-primary">
                <i class="bi bi-eye"></i> Xem chi tiết
            </a>
        </div>
    </div>

    <!-- Flash Sale Info -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <small class="text-muted">Trạng thái</small>
                    <div><span class="badge bg-@statusColor">@Model.Status</span></div>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Ngày bắt đầu</small>
                    <div>@Model.StartDate.ToLocalTime().ToString("g")</div>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Ngày kết thúc</small>
                    <div>@Model.EndDate.ToLocalTime().ToString("g")</div>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Thời lượng</small>
                    <div>@((Model.EndDate - Model.StartDate).Days) ngày</div>
                </div>
            </div>
            @if (!string.IsNullOrWhiteSpace(Model.Description))
            {
                <div class="mt-3">
                    <small class="text-muted">Mô tả</small>
                    <p class="mb-0">@Model.Description</p>
                </div>
            }
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card h-100 border-primary">
                <div class="card-body text-center">
                    <div class="text-primary mb-2">
                        <i class="bi bi-currency-dollar fs-1"></i>
                    </div>
                    <h3 class="mb-0">@Model.TotalRevenue.ToString("N0")₫</h3>
                    <small class="text-muted">Doanh thu</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-success">
                <div class="card-body text-center">
                    <div class="text-success mb-2">
                        <i class="bi bi-box-seam fs-1"></i>
                    </div>
                    <h3 class="mb-0">@Model.TotalUnitsSold</h3>
                    <small class="text-muted">Số lượng bán</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-info">
                <div class="card-body text-center">
                    <div class="text-info mb-2">
                        <i class="bi bi-receipt fs-1"></i>
                    </div>
                    <h3 class="mb-0">@Model.TotalOrders</h3>
                    <small class="text-muted">Đơn hàng</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-warning">
                <div class="card-body text-center">
                    <div class="text-warning mb-2">
                        <i class="bi bi-percent fs-1"></i>
                    </div>
                    <h3 class="mb-0">@Model.ConversionRate.ToString("F1")%</h3>
                    <small class="text-muted">Tỷ lệ chuyển đổi</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Metrics -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <small class="text-muted">Giá trị đơn trung bình</small>
                    <h5 class="mb-0">@Model.AverageOrderValue.ToString("N0")₫</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <small class="text-muted">Tổng giảm giá</small>
                    <h5 class="mb-0 text-danger">-@Model.TotalDiscount.ToString("N0")₫</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <small class="text-muted">Sản phẩm trong Flash Sale</small>
                    <h5 class="mb-0">@Model.TotalProducts</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <small class="text-muted">Doanh thu / Giảm giá</small>
                    <h5 class="mb-0">
                        @if (Model.TotalDiscount > 0)
                        {
                            var ratio = Model.TotalRevenue / Model.TotalDiscount;
                            <text>@ratio.ToString("F2")x</text>
                        }
                        else
                        {
                            @:Không có dữ liệu
                        }
                    </h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales By Day Chart -->
    @if (Model.SalesByDay.Any())
    {
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-bar-chart-line"></i> Doanh số theo thời gian</h5>
            </div>
            <div class="card-body">
                <canvas id="salesChart" height="80"></canvas>
            </div>
        </div>
    }

    <!-- Top Selling Products -->
    <div class="card mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-trophy"></i> Hiệu suất sản phẩm</h5>
            <small class="text-muted">Sắp xếp theo số lượng bán</small>
        </div>
        <div class="card-body p-0">
            @if (Model.TopProducts.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Sản phẩm</th>
                                <th class="text-end">Giá gốc</th>
                                <th class="text-end">Giá sale</th>
                                <th class="text-center">Giảm giá</th>
                                <th class="text-center">Đã bán</th>
                                <th class="text-end">Doanh thu</th>
                                <th class="text-center">Tỉ lệ bán/giới hạn</th>
                                <th class="text-center">Tồn kho</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var product in Model.TopProducts)
                            {
                                var sellThroughColor = product.SellThroughRate >= 80 ? "success" :
                                                      product.SellThroughRate >= 50 ? "warning" : "danger";
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            @if (!string.IsNullOrEmpty(product.ImageUrl))
                                            {
                                                <img src="@product.ImageUrl" alt="@product.Title" 
                                                     class="rounded me-2" 
                                                     style="width: 50px; height: 50px; object-fit: cover;">
                                            }
                                            else
                                            {
                                                <div class="bg-secondary rounded me-2 d-flex align-items-center justify-content-center" 
                                                     style="width: 50px; height: 50px;">
                                                    <i class="bi bi-image text-white"></i>
                                                </div>
                                            }
                                            <div>
                                                <a asp-controller="Products" asp-action="Details" asp-route-id="@product.ProductId" 
                                                   class="text-decoration-none fw-semibold">
                                                    @product.Title
                                                </a>
                                                @if (!string.IsNullOrEmpty(product.Author))
                                                {
                                                    <br><small class="text-muted">@product.Author</small>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <span class="text-muted text-decoration-line-through">
                                            @product.OriginalPrice.ToString("N0")₫
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <strong class="text-danger">@product.SalePrice.ToString("N0")₫</strong>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-danger">-@product.DiscountPercentage.ToString("F0")%</span>
                                    </td>
                                    <td class="text-center">
                                        <strong>@product.QuantitySold</strong>
                                    </td>
                                    <td class="text-end">
                                        <strong>@product.Revenue.ToString("N0")₫</strong>
                                        <br><small class="text-success">-@product.TotalDiscount.ToString("N0")₫ tiết kiệm</small>
                                    </td>
                                    <td class="text-center">
                                        @if (product.StockLimit.HasValue)
                                        {
                                            <div class="mb-1">
                                                <span class="badge bg-@sellThroughColor">
                                                    @product.SellThroughRate.ToString("F0")%
                                                </span>
                                            </div>
                                            <div class="progress" style="height: 5px;">
                                                <div class="progress-bar bg-@sellThroughColor" 
                                                     role="progressbar" 
                                                     style="width: @product.SellThroughRate%"
                                                     aria-valuenow="@product.SellThroughRate" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100"></div>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (product.StockLimit.HasValue)
                                        {
                                            if (product.StockRemaining > 0)
                                            {
                                                <span class="text-success">Còn @product.StockRemaining</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Hết hàng</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">Không giới hạn</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="text-muted mt-2">Chưa có dữ liệu bán hàng</p>
                </div>
            }
        </div>
    </div>

    <!-- Export Options -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title"><i class="bi bi-download"></i> Xuất dữ liệu</h5>
            <p class="text-muted">Tải dữ liệu phân tích để xử lý thêm</p>
            <button id="exportCSVBtn" class="btn btn-outline-primary">
                <i class="bi bi-file-earmark-spreadsheet"></i> Xuất CSV
            </button>
            <button id="printReportBtn" class="btn btn-outline-success">
                <i class="bi bi-printer"></i> In báo cáo
            </button>
        </div>
    </div>
</div>

@section Scripts {
    @if (Model.SalesByDay.Any())
    {
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <script>
            // Biểu đồ doanh số
            const ctx = document.getElementById('salesChart').getContext('2d');
            const salesData = {
                labels: [@Html.Raw(string.Join(",", Model.SalesByDay.Select(d => $"'{d.Date:MMM dd}'")))],
                datasets: [
                    {
                        label: 'Doanh thu (₫)',
                        data: [@string.Join(",", Model.SalesByDay.Select(d => d.Revenue))],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        yAxisID: 'y',
                    },
                    {
                        label: 'Số lượng bán',
                        data: [@string.Join(",", Model.SalesByDay.Select(d => d.UnitsSold))],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        yAxisID: 'y1',
                    }
                ]
            };

            new Chart(ctx, {
                type: 'line',
                data: salesData,
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Doanh thu (₫)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Số lượng'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                    }
                }
            });
        </script>
    }
    
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            const exportBtn = document.getElementById('exportCSVBtn');
            if (exportBtn){
                exportBtn.addEventListener('click', exportToCSV);
            }
            const printBtn = document.getElementById('printReportBtn');
            if (printBtn){
                printBtn.addEventListener('click', printReport);
            }
        })
        // Dữ liệu sản phẩm để xuất CSV, được serialize và convert sang JS array
        const productsData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.TopProducts.Select(p => new {
                Title = p.Title ?? string.Empty,
                OriginalPrice = p.OriginalPrice,
                SalePrice = p.SalePrice,
                DiscountPercentage = Math.Round(p.DiscountPercentage, 2),
                QuantitySold = p.QuantitySold,
                Revenue = p.Revenue,
                TotalDiscount = p.TotalDiscount
            })
        ));

        function csvEscape(value) {
            // Escape dấu ngoặc kép và bao quanh bằng dấu ngoặc kép
            if (value === null || value === undefined) return '';
            const str = String(value).replace(/"/g, '""');
            return '"' + str + '"';
        }

        function exportToCSV() {
            const headers = ['Sản phẩm','Giá gốc','Giá sale','% Giảm','Đã bán','Doanh thu','Giảm giá'];
            const lines = [headers.map(csvEscape).join(',')];
            for (const p of productsData) {
                const row = [
                    p.Title.replace(/'/g, ''),
                    p.OriginalPrice,
                    p.SalePrice,
                    p.DiscountPercentage,
                    p.QuantitySold,
                    p.Revenue,
                    p.TotalDiscount
                ].map(csvEscape).join(',');
                lines.push(row);
            }
            const csv = lines.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'flash-sale-analytics-@(Model.FlashSaleId).csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            // Giải phóng URL đối tượng sau khi tải xuống 
            window.URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }
    </script>
}

@section Styles {
    <style>
        @@media print {
            .btn, .card-header a {
                display: none !important;
            }
        }
    </style>
}
