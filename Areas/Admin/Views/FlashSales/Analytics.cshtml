@model Bookstore.ViewModels.Admin.FlashSaleAnalyticsViewModel

@{
    ViewData["Title"] = "Flash Sale Analytics";
    var statusColor = Model.Status switch
    {
        "Active" => "success",
        "Upcoming" => "info",
        "Expired" => "secondary",
        _ => "warning"
    };
}

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-graph-up"></i> Flash Sale Analytics</h2>
            <p class="text-muted mb-0">@Model.Name</p>
        </div>
        <div>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
            <a asp-action="Details" asp-route-id="@Model.FlashSaleId" class="btn btn-outline-primary">
                <i class="bi bi-eye"></i> View Details
            </a>
        </div>
    </div>

    <!-- Flash Sale Info -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <small class="text-muted">Status</small>
                    <div><span class="badge bg-@statusColor">@Model.Status</span></div>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Start Date</small>
                    <div>@Model.StartDate.ToLocalTime().ToString("g")</div>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">End Date</small>
                    <div>@Model.EndDate.ToLocalTime().ToString("g")</div>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Duration</small>
                    <div>@((Model.EndDate - Model.StartDate).Days) days</div>
                </div>
            </div>
            @if (!string.IsNullOrWhiteSpace(Model.Description))
            {
                <div class="mt-3">
                    <small class="text-muted">Description</small>
                    <p class="mb-0">@Model.Description</p>
                </div>
            }
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card h-100 border-primary">
                <div class="card-body text-center">
                    <div class="text-primary mb-2">
                        <i class="bi bi-currency-dollar fs-1"></i>
                    </div>
                    <h3 class="mb-0">@Model.TotalRevenue.ToString("N0")₫</h3>
                    <small class="text-muted">Total Revenue</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-success">
                <div class="card-body text-center">
                    <div class="text-success mb-2">
                        <i class="bi bi-box-seam fs-1"></i>
                    </div>
                    <h3 class="mb-0">@Model.TotalUnitsSold</h3>
                    <small class="text-muted">Units Sold</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-info">
                <div class="card-body text-center">
                    <div class="text-info mb-2">
                        <i class="bi bi-receipt fs-1"></i>
                    </div>
                    <h3 class="mb-0">@Model.TotalOrders</h3>
                    <small class="text-muted">Orders</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-warning">
                <div class="card-body text-center">
                    <div class="text-warning mb-2">
                        <i class="bi bi-percent fs-1"></i>
                    </div>
                    <h3 class="mb-0">@Model.ConversionRate.ToString("F1")%</h3>
                    <small class="text-muted">Conversion Rate</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Metrics -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <small class="text-muted">Average Order Value</small>
                    <h5 class="mb-0">@Model.AverageOrderValue.ToString("N0")₫</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <small class="text-muted">Total Discount Given</small>
                    <h5 class="mb-0 text-danger">-@Model.TotalDiscount.ToString("N0")₫</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <small class="text-muted">Products in Sale</small>
                    <h5 class="mb-0">@Model.TotalProducts</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <small class="text-muted">Revenue vs Discount</small>
                    <h5 class="mb-0">
                        @if (Model.TotalDiscount > 0)
                        {
                            var ratio = Model.TotalRevenue / Model.TotalDiscount;
                            <text>@ratio.ToString("F2")x</text>
                        }
                        else
                        {
                            @:N/A
                        }
                    </h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales By Day Chart -->
    @if (Model.SalesByDay.Any())
    {
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-bar-chart-line"></i> Sales Over Time</h5>
            </div>
            <div class="card-body">
                <canvas id="salesChart" height="80"></canvas>
            </div>
        </div>
    }

    <!-- Top Selling Products -->
    <div class="card mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-trophy"></i> Product Performance</h5>
            <small class="text-muted">Sorted by units sold</small>
        </div>
        <div class="card-body p-0">
            @if (Model.TopProducts.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th class="text-end">Original Price</th>
                                <th class="text-end">Sale Price</th>
                                <th class="text-center">Discount</th>
                                <th class="text-center">Sold</th>
                                <th class="text-end">Revenue</th>
                                <th class="text-center">Sell-Through</th>
                                <th class="text-center">Stock</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var product in Model.TopProducts)
                            {
                                var sellThroughColor = product.SellThroughRate >= 80 ? "success" :
                                                      product.SellThroughRate >= 50 ? "warning" : "danger";
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            @if (!string.IsNullOrEmpty(product.ImageUrl))
                                            {
                                                <img src="@product.ImageUrl" alt="@product.Title" 
                                                     class="rounded me-2" 
                                                     style="width: 50px; height: 50px; object-fit: cover;">
                                            }
                                            else
                                            {
                                                <div class="bg-secondary rounded me-2 d-flex align-items-center justify-content-center" 
                                                     style="width: 50px; height: 50px;">
                                                    <i class="bi bi-image text-white"></i>
                                                </div>
                                            }
                                            <div>
                                                <a asp-controller="Products" asp-action="Details" asp-route-id="@product.ProductId" 
                                                   class="text-decoration-none fw-semibold">
                                                    @product.Title
                                                </a>
                                                @if (!string.IsNullOrEmpty(product.Author))
                                                {
                                                    <br><small class="text-muted">@product.Author</small>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <span class="text-muted text-decoration-line-through">
                                            @product.OriginalPrice.ToString("N0")₫
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <strong class="text-danger">@product.SalePrice.ToString("N0")₫</strong>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-danger">-@product.DiscountPercentage.ToString("F0")%</span>
                                    </td>
                                    <td class="text-center">
                                        <strong>@product.QuantitySold</strong>
                                    </td>
                                    <td class="text-end">
                                        <strong>@product.Revenue.ToString("N0")₫</strong>
                                        <br><small class="text-success">-@product.TotalDiscount.ToString("N0")₫ saved</small>
                                    </td>
                                    <td class="text-center">
                                        @if (product.StockLimit.HasValue)
                                        {
                                            <div class="mb-1">
                                                <span class="badge bg-@sellThroughColor">
                                                    @product.SellThroughRate.ToString("F0")%
                                                </span>
                                            </div>
                                            <div class="progress" style="height: 5px;">
                                                <div class="progress-bar bg-@sellThroughColor" 
                                                     role="progressbar" 
                                                     style="width: @product.SellThroughRate%"
                                                     aria-valuenow="@product.SellThroughRate" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100"></div>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (product.StockLimit.HasValue)
                                        {
                                            if (product.StockRemaining > 0)
                                            {
                                                <span class="text-success">@product.StockRemaining left</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Sold Out</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">Unlimited</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="text-muted mt-2">No sales data available yet</p>
                </div>
            }
        </div>
    </div>

    <!-- Export Options -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title"><i class="bi bi-download"></i> Export Data</h5>
            <p class="text-muted">Download analytics data for further analysis</p>
            <button class="btn btn-outline-primary" onclick="exportToCSV()">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export to CSV
            </button>
            <button class="btn btn-outline-success" onclick="printReport()">
                <i class="bi bi-printer"></i> Print Report
            </button>
        </div>
    </div>
</div>

@section Scripts {
    @if (Model.SalesByDay.Any())
    {
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <script>
            // Sales Chart
            const ctx = document.getElementById('salesChart').getContext('2d');
            const salesData = {
                labels: [@Html.Raw(string.Join(",", Model.SalesByDay.Select(d => $"'{d.Date:MMM dd}'")))],
                datasets: [
                    {
                        label: 'Revenue (₫)',
                        data: [@string.Join(",", Model.SalesByDay.Select(d => d.Revenue))],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        yAxisID: 'y',
                    },
                    {
                        label: 'Units Sold',
                        data: [@string.Join(",", Model.SalesByDay.Select(d => d.UnitsSold))],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        yAxisID: 'y1',
                    }
                ]
            };

            new Chart(ctx, {
                type: 'line',
                data: salesData,
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Revenue (₫)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Units'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                    }
                }
            });
        </script>
    }
    
    <script>
        function exportToCSV() {
            // Simple CSV export
            let csv = 'Product,Original Price,Sale Price,Discount %,Units Sold,Revenue,Discount Given\n';
            // Razor code block to loop through products
            // Example: csv += 'The Great Gatsby','150000','99000','34.00','50','4950000','2550000\n';
            @foreach (var product in Model.TopProducts)
            {
                @:csv += '@product.Title.Replace("'", "")','+ '@product.OriginalPrice' + ',' + '@product.SalePrice' + ',' + '@product.DiscountPercentage.ToString("F2")' + ',' + '@product.QuantitySold' + ',' + '@product.Revenue' + ',' + '@product.TotalDiscount' + '\n';
            }
            // Creating a File in the Browser with Blob object. type tells the browser this is a CSV file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            // Triggering the Download itself
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'flash-sale-analytics-@(Model.FlashSaleId).csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function printReport() {
            window.print();
        }
    </script>
}

@section Styles {
    <style>
        @@media print {
            .btn, .card-header a {
                display: none !important;
            }
        }
    </style>
}
