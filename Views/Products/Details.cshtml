@using Bookstore.ViewModels
@model ProductDetailsViewModel

@{
    ViewData["Title"] = "Product Details"; 
    // Declare imageUrl and mainImage here so they are accessible globally in the view
    // Initialize with a default value to handle the case where Model.Product is null
    string imageUrl = Url.Content("~/images/no-image.svg");
    var hasFlashSale = Model.FlashSale != null;
    var effectivePrice = hasFlashSale ? Model.FlashSale!.SalePrice : Model.Product?.Price ?? 0;

    if (Model.Product != null)
    {
        ViewData["Title"] = Model.Product.Title;
        var mainImage = Model.Product.ProductImages?.FirstOrDefault(i => i.IsMain) ?? Model.Product.ProductImages?.FirstOrDefault();
        imageUrl = mainImage?.ImageUrl ?? Url.Content("~/images/no-image.svg"); 
    }
    // Compute available quantity for display and purchase 
    var totalStock = Model.Product?.Stock ?? 0;
    int? flashRemaining = null;
    if (hasFlashSale && Model.FlashSale!.StockLimit.HasValue)
    {
        flashRemaining = Math.Max(0, Model.FlashSale.StockLimit.Value - Model.FlashSale.SoldCount);
    }
    var availableToSell = (hasFlashSale && flashRemaining.HasValue) 
        ? Math.Min(totalStock, flashRemaining.Value) 
        : totalStock;
    var isInStock = availableToSell > 0;
}

<div class="container my-4">
    @if (hasFlashSale)
    {
        <div class="alert alert-danger flash-sale-banner mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">
                        <i class="bi bi-lightning-charge-fill"></i>
                        ‚ö° FLASH SALE - Gi·∫£m @Model.FlashSale!.DiscountPercentage.ToString("F0")%
                    </h4>
                    <p class="mb-0">Ti·∫øt ki·ªám @((Model.Product!.Price - Model.FlashSale.SalePrice).ToString("N0"))‚Ç´</p>
                </div>
                <div class="text-end">
                    <div class="countdown" 
                         data-end-date="@Model.FlashSale.FlashSale!.EndDate.ToString("yyyy-MM-ddTHH:mm:ss")">
                        <div class="countdown-timer" id="countdown">
                            <i class="bi bi-clock"></i>
                            <span>ƒêang t·∫£i...</span>
                        </div>
                    </div>
                    @if (Model.FlashSale.StockLimit.HasValue)
                    {
                        var remaining = Model.FlashSale.StockLimit.Value - Model.FlashSale.SoldCount;
                        var percentage = (double)remaining / Model.FlashSale.StockLimit.Value * 100;
                        <div class="mt-2">
                            <small>Ch·ªâ c√≤n <strong>@remaining</strong> s·∫£n ph·∫©m v·ªõi gi√° Flash Sale</small>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar bg-warning" 
                                     role="progressbar" 
                                     style="width: @percentage%"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    <div class="row">
        <div class="col-md-5">
            <img src="@imageUrl" class="img-fluid rounded main-product-image" alt="@(Model.Product?.Title ?? "Product")" style="object-fit:cover; width:100%; height:420px;" />

            @if (Model.Product?.ProductImages != null && Model.Product.ProductImages.Count() > 1) // Added null checks for Product and ProductImages
            {
                <div class="mt-2 d-flex gap-2">
                    @foreach (var img in Model.Product.ProductImages.Take(4)) // Changed Images to ProductImages
                    {
                        <img src="@img.ImageUrl" style="width:85px; height:70px; object-fit:cover; cursor:pointer;" onclick="document.querySelector('.main-product-image').src='@img.ImageUrl';" />
                    }
                </div>
            }
        </div>

        <div class="col-md-7">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h3 class="mb-0">@(Model.Product?.Title ?? "Product Not Found")</h3>
                <button type="button"
                        class="btn btn-link p-0 favorite-toggle"
                        data-product-id="@Model.Product?.ProductId"
                        title="@(Model.IsFavorited ? "Remove from Favorites" : "Add to Favorites")"
                        aria-label="@(Model.IsFavorited ? "Remove from Favorites" : "Add to Favorites")">
                    <i class="@(Model.IsFavorited ? "fa-solid fa-heart text-danger" : "fa-regular fa-heart")"></i>
                </button>
            </div>
            
            <p class="text-muted">T√°c gi·∫£: @(Model.Product?.Author ?? "N/A")</p>
        
            @if (hasFlashSale)
            {
                <div class="price-section mb-3">
                    <div class="d-flex align-items-baseline gap-2">
                        <h3 class="text-danger mb-0">@effectivePrice.ToString("N0")‚Ç´</h3>
                        <span class="text-muted text-decoration-line-through fs-5">
                            @Model.Product?.Price.ToString("N0")‚Ç´
                        </span>
                        <span class="badge bg-danger fs-6">
                            -@Model.FlashSale!.DiscountPercentage.ToString("F0")%
                        </span>
                    </div>
                </div>
            } else {
                <h4 class="text-danger">@(Model.Product?.Price.ToString("N0") ?? "0")‚Ç´</h4>
            }

            <p><strong>Th·ªÉ lo·∫°i:</strong> @(Model.Product?.Category?.Name ?? "N/A")</p>
            <p>
                <strong>T√¨nh tr·∫°ng:</strong>
                @if (hasFlashSale && flashRemaining.HasValue)
                {
                    if (availableToSell > 0)
                    {
                        @:C√≤n h√†ng (@availableToSell)
                    }
                    else
                    {
                        @:<span class="text-danger">H·∫øt h√†ng (Flash Sale)</span>
                    }
                }
                else
                {
                    @:(Model.Product?.Stock > 0 ? $"C√≤n h√†ng ({Model.Product.Stock})" : "H·∫øt h√†ng")
                }
            </p>
            @if (Model.Product != null) // Only show quantity and cart if product exists
            {
                <div class="mb-3">
                    <label for="qty" class="form-label">S·ªë l∆∞·ª£ng</label>
                    <input id="qty" class="form-control" type="number" value="1" min="1" max="@Model.Product.Stock" style="width:100px;" />
                </div>

                <div class="mb-3">
                    <button class="btn @(hasFlashSale ? "btn-danger" : "btn-primary") btn-lg" 
                            id="btnAddCart" 
                            data-id="@Model.Product.ProductId"
                            data-flash-sale-id="@Model.FlashSale?.FlashSaleProductId">
                        @(hasFlashSale ? "üî• Mua ngay - Flash Sale" : "Th√™m v√†o gi·ªè")
                    </button>
                    <a asp-controller="Cart" asp-action="Index" class="btn btn-outline-secondary ms-2">Xem gi·ªè h√†ng</a>
                </div>

                <h5>M√¥ t·∫£</h5>
                <div>@Html.Raw(Model.Product.Description)</div>
            }
            else
            {
                <div class="alert alert-warning">Product details are not available.</div>
            }
        </div>
    </div>

    @if (Model.RelatedProducts != null && Model.RelatedProducts.Any())
    {
        <hr class="my-4" />
        <h5>S√°ch li√™n quan</h5>
        <div class="row g-3">
            @foreach (var rp in Model.RelatedProducts)
            {
                <div class="col-6 col-md-3">
                    @await Html.PartialAsync("_ProductCard", rp)
                </div>
            }
        </div>
    }

    @if (Model.RecentlyViewedProducts != null && Model.RecentlyViewedProducts.Any())
    {
        <hr class="my-4" />
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Recently Viewed</h5>
            <a asp-action="RecentlyViewed" class="btn btn-sm btn-outline-secondary">View all</a>
        </div>
        <div class="row g-3">
            @foreach (var recent in Model.RecentlyViewedProducts)
            {
                <div class="col-6 col-md-3">
                    @await Html.PartialAsync("_ProductCard", recent)
                </div>
            }
        </div>
    }
</div>

@section Styles {
    <style>
        .flash-sale-banner {
            background: linear-gradient(135deg, #ff4444, #ff6b6b);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 8px;
        }
        
        .countdown-timer {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .price-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ff4444;
        }
    </style>
}

@section Scripts {
    <script>
        // Countdown timer
        function updateCountdown() {
            const countdownEl = document.querySelector('.countdown');
            if (!countdownEl) return;
            
            const endDate = new Date(countdownEl.dataset.endDate);
            const now = new Date();
            const diff = endDate - now;
            
            if (diff <= 0) {
                document.getElementById('countdown').innerHTML = '<i class="bi bi-x-circle"></i> <span>Flash Sale ƒë√£ k·∫øt th√∫c</span>';
                location.reload(); // Reload page khi sale k·∫øt th√∫c
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            let timeString = '';
            if (days > 0) timeString += `${days} ng√†y `;
            timeString += `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('countdown').innerHTML = `<i class="bi bi-clock"></i> <span>K·∫øt th√∫c sau: ${timeString}</span>`;
        }
        
        if (document.querySelector('.countdown')) {
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }
        
        // Add to cart with flash sale support
        document.getElementById('btnAddCart')?.addEventListener('click', async function () {
            var id = this.dataset.id;
            var flashSaleId = this.dataset.flashSaleId || null;
            var qty = document.getElementById('qty').value || 1;
            
            try {
                const resp = await fetch('/Cart/AddToCart', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value 
                    },
                    body: JSON.stringify({ 
                        productId: id, 
                        quantity: qty,
                        flashSaleProductId: flashSaleId 
                    })
                });
                
                if (resp.ok) {
                    const data = await resp.json();
                    alert(data.message || 'ƒê√£ th√™m v√†o gi·ªè h√†ng');
                    if (typeof updateCartCount === 'function') {
                        updateCartCount();
                    }
                } else {
                    const data = await resp.json();
                    alert('L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ th√™m v√†o gi·ªè h√†ng'));
                }
            } catch (e) {
                alert('L·ªói khi th√™m gi·ªè h√†ng');
            }
        });
    </script>
}